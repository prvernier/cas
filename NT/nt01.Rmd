---  
title: "NT01 Conversion"
date: "Updated: `r format(Sys.time(), '%d %B %Y')`"
output:  
  html_document:  
    code_folding: hide
    toc: true
    toc_float:
      collapsed: true
    css: styles.css
---  

```{r echo=FALSE, message=FALSE, warning=FALSE}  
library(rpostgis)
library(rmarkdown)
library(tidyverse)
library(summarytools)
if (is.null(x)) {
    con = dbConnect(RPostgreSQL::PostgreSQL(), dbname="casfri50_pierrev", host="localhost", port=5432, user="postgres", password="1postgres")
    nt01 = st_read(con, query="SELECT * from rawfri.nt01;")
    y = mutate(nt01, tmp_area=st_area(nt01), tmp_length=st_length(nt01))
    x = as_tibble(y)
    #x = as_tibble(dbGetQuery(con, "SELECT * FROM rawfri.nt01"))
    dbDisconnect(con)
}
```

<br>

# CAS Attributes

## cas_id

The cas_id is a concatenation of ('nt01', NF_FORCOV, invproj_id, fc_id_1, ogc_fid).

## orig_stand_id {.tabset}


```{r echo=TRUE, message=FALSE, warning=FALSE}  
x = mutate(x, orig_stand_id = fc_id_1)
```

### RAWFRI

```{r echo=FALSE, message=FALSE, warning=FALSE}  
dfSummary(x["fc_id_1"], graph.col=FALSE, max.distinct.values=99)
```

### CASFRI

```{r echo=FALSE, message=FALSE, warning=FALSE}  
dfSummary(x["orig_stand_id"], graph.col=FALSE, max.distinct.values=99)
```

## stand_structure {.tabset}

  * The following occur but are not mentioned in the NWT manual: "^","V","x"

```{r echo=TRUE, message=FALSE, warning=FALSE}
friList = c("C","H","M","S")
casList = c("C","H","M","S")
x = mutate(x, stand_structure=case_when(
    str_trim(structur)=="" ~ "EMPTY_STRING",
    is.na(structur) ~ "NULL_VALUE",
    !structur %in% friList ~ "NOT_IN_SET",
    TRUE ~ mapvalues(structur, friList, casList)
    ))
```

### RAWFRI

```{r echo=FALSE, message=FALSE, warning=FALSE}  
dfSummary(x["structur"], graph.col=FALSE, max.distinct.values=99)
```

### CASFRI

```{r echo=FALSE, message=FALSE, warning=FALSE}  
dfSummary(x["stand_structure"], graph.col=FALSE, max.distinct.values=99)
```

## num_of_layers {.tabset}

  - CASFRI specifies up to 2 layers but not the source attribute. Ask J Cosco?
  - CAS04 takes values of 1 or 2, so there must be an attribute that is used. Check beautiful Perl code!

```{r echo=TRUE, message=FALSE, warning=FALSE}  
```

### RAWFRI

### CASFRI

```{r echo=FALSE, message=FALSE, warning=FALSE}  
#dfSummary(x["num_of_layers"], graph.col=FALSE, max.distinct.values=99)
```

## identification_id {.tabset}

  * The identification_id takes a value of 1.

```{r echo=TRUE, message=FALSE, warning=FALSE}
x = mutate(x, identification_id = 1)
```

### RAWFRI

### CASFRI

```{r echo=FALSE, message=FALSE, warning=FALSE}  
dfSummary(x["identification_id"], graph.col=FALSE, max.distinct.values=99)
```

## map_sheet_id {.tabset}

  - There doesn't seem to be a source attribute for this (unless maybe stand_20k but it's empty) and the CAS04 assigns value of -1111

```{r echo=TRUE, message=FALSE, warning=FALSE}  
x = mutate(x, map_sheet_id = "NULL_VALUE")
```

### RAWFRI


### CASFRI

```{r echo=FALSE, message=FALSE, warning=FALSE}  
dfSummary(x["map_sheet_id"], graph.col=FALSE, max.distinct.values=10)
```

## casfri_area {.tabset}

```{r echo=TRUE, message=FALSE, warning=FALSE}  
x = mutate(x, casfri_area= round(tmp_area,1))
```

### RAWFRI

```{r echo=FALSE, message=FALSE, warning=FALSE}  
dfSummary(x["tmp_area"], graph.col=FALSE, max.distinct.values=99)
```

### CASFRI

```{r echo=FALSE, message=FALSE, warning=FALSE}  
dfSummary(x["casfri_area"], graph.col=FALSE, max.distinct.values=99)
```

## casfri_perimeter {.tabset}

  - Has CASFRI_PERIMETER been dropped (see issue #171 in CASFRI github pages)

```{r echo=TRUE, message=FALSE, warning=FALSE}  
#x = mutate(x, casfri_perimeter = round(tmp_length,0))
```

### RAWFRI

```{r echo=FALSE, message=FALSE, warning=FALSE}  
#dfSummary(x["tmp_length"], graph.col=FALSE, max.distinct.values=99)
```

### CASFRI

```{r echo=FALSE, message=FALSE, warning=FALSE}  
#dfSummary(x["casfri_perimeter"], graph.col=FALSE, max.distinct.values=99)
```

## src_inv_area {.tabset}

```{r echo=TRUE, message=FALSE, warning=FALSE}  
x = mutate(x, src_inv_area = round(areaha/10000,1))
```

### RAWFRI

```{r echo=FALSE, message=FALSE, warning=FALSE}  
dfSummary(x["areaha"], graph.col=FALSE, max.distinct.values=99)
```

### CASFRI

```{r echo=FALSE, message=FALSE, warning=FALSE}  
dfSummary(x["src_inv_area"], graph.col=FALSE, max.distinct.values=99)
```

## stand_photo_year {.tabset}

  - should we use ref_year?

```{r echo=TRUE, message=FALSE, warning=FALSE}  
x = mutate(x, stand_photo_year = ref_year)
```

### RAWFRI

```{r echo=FALSE, message=FALSE, warning=FALSE}  
dfSummary(x["ref_year"], graph.col=FALSE, max.distinct.values=99)
```

### CASFRI

```{r echo=FALSE, message=FALSE, warning=FALSE}  
dfSummary(x["stand_photo_year"], graph.col=FALSE, max.distinct.values=99)
```

<br>


# LYR Attributes

## soil_moist_reg {.tabset}

  - a couple errors: N/ and sn i.e., NOT_IN_SET
  - not clear from manual what the minmoist source attribute is, so ignoring for now

```{r echo=TRUE, message=FALSE, warning=FALSE}  
friList = c('vx','x','sx','sm','m','sg','hg','sd','hd')
casList = c('D','D','D','F','F','M','M','W','W')
x = mutate(x, soil_moist_reg=case_when(
    str_trim(moisture)=="" ~ "EMPTY_STRING",
    is.na(moisture) ~ "NULL_VALUE",
    !moisture %in% friList ~ "NOT_IN_SET",
    TRUE ~ mapvalues(moisture, friList, casList)
    ))
```

### RAWFRI

```{r echo=FALSE, message=FALSE, warning=FALSE}  
dfSummary(x["moisture"], graph.col=FALSE, max.distinct.values=99)
```
### CASFRI

```{r echo=FALSE, message=FALSE, warning=FALSE}  
dfSummary(x["soil_moist_reg"], graph.col=FALSE, max.distinct.values=99)
```

## structure_per {.tabset}

  - allowable codes from p 66 of manual are 1-9, so assuming that 0 is null value i.e., -9999
  - a couple errors: 11 and 12

```{r echo=TRUE, message=FALSE, warning=FALSE}  
x = mutate(x, structure_per=case_when(
    strc_per==0 | is.na(strc_per) ~ -9999,
    !strc_per %in% c(1:9) ~ -8887,
    TRUE ~ as.numeric(strc_per)
    ))
```

### RAWFRI

```{r echo=FALSE, message=FALSE, warning=FALSE}  
dfSummary(x["strc_per"], graph.col=FALSE, max.distinct.values=99)
```

### CASFRI

```{r echo=FALSE, message=FALSE, warning=FALSE}  
dfSummary(x["structure_per"], graph.col=FALSE, max.distinct.values=99)
```

## layer {.tabset}

  - Cosco appendix 3 seems to mix up structure and layer attributes
  - here we assign a default value of 1 since no obvious corresponding source attribute

```{r echo=TRUE, message=FALSE, warning=FALSE}  
x = mutate(x, layer=1)
```

### RAWFRI

### CASFRI

```{r echo=FALSE, message=FALSE, warning=FALSE}  
dfSummary(x["layer"], graph.col=FALSE, max.distinct.values=99)
```

## layer_rank {.tabset}

  - no source attribute, so assign value of 1

```{r echo=TRUE, message=FALSE, warning=FALSE}  
x = mutate(x, layer_rank=1)
```

### RAWFRI

### CASFRI

```{r echo=FALSE, message=FALSE, warning=FALSE}  
dfSummary(x["layer_rank"], graph.col=FALSE, max.distinct.values=99)
```

## crown_closure {.tabset}

```{r echo=TRUE, message=FALSE, warning=FALSE}  
x = mutate(x, crown_closure_lower=case_when(
    is.na(crownclos) ~ -9999,
    !crownclos %in% 0:100 ~ -8887,
    TRUE ~ as.numeric(crownclos)
    ))
x = mutate(x, crown_closure_upper=crown_closure_lower)
```

### RAWFRI

```{r echo=FALSE, message=FALSE, warning=FALSE}  
dfSummary(x["crownclos"], graph.col=FALSE, max.distinct.values=99)
```

### CASFRI (lower)

```{r echo=FALSE, message=FALSE, warning=FALSE}  
dfSummary(x["crown_closure_lower"], graph.col=FALSE, max.distinct.values=101)
```

### CASFRI (upper)

```{r echo=FALSE, message=FALSE, warning=FALSE}  
dfSummary(x["crown_closure_upper"], graph.col=FALSE, max.distinct.values=101)
```

## height {.tabset}

```{r echo=TRUE, message=FALSE, warning=FALSE}  
x = mutate(x, height_lower=case_when(
    height==0 | is.na(height) ~ -9999,
    !height %in% 1:100 ~ -8887,
    TRUE ~ as.numeric(height)
    ))
x = mutate(x, height_upper=height_lower)
```

### RAWFRI

```{r echo=FALSE, message=FALSE, warning=FALSE}  
dfSummary(x["height"], graph.col=FALSE, max.distinct.values=99)
```

### CASFRI (lower)

```{r echo=FALSE, message=FALSE, warning=FALSE}  
dfSummary(x["height_lower"], graph.col=FALSE, max.distinct.values=99)
```

### CASFRI (upper)

```{r echo=FALSE, message=FALSE, warning=FALSE}  
dfSummary(x["height_upper"], graph.col=FALSE, max.distinct.values=99)
```

## species_1-10 {.tabset}

  - need to create proper species lookup table

```{r echo=TRUE, message=FALSE, warning=FALSE}  
sppList = read_csv("../../casfri/translation/tables/lookup/nt_avi01_species.csv")
x = mutate(x, species_1=case_when(
    is.na(sp1) ~ "NULL_VALUE",
    str_trim(sp1)=="" ~ "EMPTY_STRING",
    !sp1 %in% sppList$SOURCE_VAL ~ "NOT_IN_SET",
    TRUE ~ mapvalues(sp1, sppList$SOURCE_VAL, sppList$SPEC1)))
```

### RAWFRI

```{r echo=FALSE, message=FALSE, warning=FALSE}  
dfSummary(x["sp1"], graph.col=FALSE, max.distinct.values=99)
```
### CASFRI

```{r echo=FALSE, message=FALSE, warning=FALSE}  
dfSummary(x["species_1"], graph.col=FALSE, max.distinct.values=99)
```

## species_per_1-10 {.tabset}

```{r echo=TRUE, message=FALSE, warning=FALSE}  
x = mutate(x, species_per_1=case_when(
    is.na(sp1_per) ~ as.integer(-8888),
    sp1_per < 0 | sp1_per > 100 ~ as.integer(-9999),
    TRUE ~ as.integer(sp1_per)))
```

### RAWFRI

```{r echo=FALSE, message=FALSE, warning=FALSE}  
dfSummary(x["sp1_per"], graph.col=FALSE, max.distinct.values=99)
```

### CASFRI

```{r echo=FALSE, message=FALSE, warning=FALSE}  
dfSummary(x["species_per_1"], graph.col=FALSE, max.distinct.values=99)
```

## productive_for {.tabset}

  - what do we do with this one?

```{r echo=TRUE, message=FALSE, warning=FALSE}  
#x = mutate(x, productive_for=if_else(modcon1!="CC" & species_1=="EMPTY_STRING" & (crown_closure_upper!=-9998 | height_upper!=-9999), "PP", "PF"))
```

### RAWFRI

```{r echo=FALSE, message=FALSE, warning=FALSE}  
#dfSummary(x[""], graph.col=FALSE, max.distinct.values=99)
```

### CASFRI

```{r echo=FALSE, message=FALSE, warning=FALSE}  
#dfSummary(x["productive_for"], graph.col=FALSE, max.distinct.values=99)
```

## origin {.tabset}

```{r echo=TRUE, message=FALSE, warning=FALSE}
x = mutate(x, origin_upper=if_else(origin==0,-9999,as.double(origin)),
              origin_lower=if_else(origin==0,-9999,as.double(origin)))
```

### RAWFRI

```{r echo=FALSE, message=FALSE, warning=FALSE}  
dfSummary(x["origin"], graph.col=FALSE, max.distinct.values=99)
```

### CASFRI (lower)

```{r echo=FALSE, message=FALSE, warning=FALSE}  
dfSummary(x["origin_lower"], graph.col=FALSE, max.distinct.values=99)
```

### CASFRI (upper)

```{r echo=FALSE, message=FALSE, warning=FALSE}  
dfSummary(x["origin_upper"], graph.col=FALSE, max.distinct.values=99)
```


## site_class {.tabset}

```{r echo=TRUE, message=FALSE, warning=FALSE}  
friList = c('5','4','3','2','1')
casList = c('U','P','M','G','G')
x = mutate(x, site_class=case_when(
    str_trim(siteclass)=="" ~ "EMPTY_STRING",
    is.na(siteclass) ~ "NULL_VALUE",
    !siteclass %in% friList ~ "NOT_IN_SET",
    TRUE ~ mapvalues(siteclass, friList, casList)
    ))
```

### RAWFRI

```{r echo=FALSE, message=FALSE, warning=FALSE}  
dfSummary(x["siteclass"], graph.col=FALSE, max.distinct.values=99)
```

### CASFRI

```{r echo=FALSE, message=FALSE, warning=FALSE}  
dfSummary(x["site_class"], graph.col=FALSE, max.distinct.values=99)
```

## site_index {.tabset}

```{r echo=TRUE, message=FALSE, warning=FALSE}
x = mutate(x, site_index=case_when(
    is.na(si_50) ~ as.numeric(-8888),
    si_50 < 0.1 | sp1_per > 99.0 ~ as.numeric(-9999),
    TRUE ~ as.numeric(si_50)
    ))
```

### RAWFRI

```{r echo=FALSE, message=FALSE, warning=FALSE}  
dfSummary(x["si_50"], graph.col=FALSE, max.distinct.values=99)
```

### CASFRI

```{r echo=FALSE, message=FALSE, warning=FALSE}  
dfSummary(x["site_index"], graph.col=FALSE, max.distinct.values=99)
```


# NFL Attributes

  - Only one source attributes seems to be used: siteclass (siteclas); this means that source values that are not in NWT manual will be flagged 3 times as "NOT_IN_SET"?
  - fri = c('AP','BE','BL','BM','BP','BR','BU','BY','CB','EL','ES','GP','HE','HF','HG','LA','LL','LS','MO','MU','PO','RD','RE','RI','RO','RS','RT','SL','ST','TB','TC','TM','TS','x','XX')
  - cas = c('FA','BE','BR','BR','SE','RK','EX','BR','EX','OT','EX','IN','HE','HF','HG','LA','EX','WS','EX','EX','LA','  ','LA','RI','RK','WS','RK','SL','ST','  ','  ','  ','OT',' ','  ')
  - source attributes 'MO','RS','TS' have no CASFRI code; assign to 'EX','WS','OT'
  - source attributes 'TB','TC','TM' are forested classes; assign to "NULL_VALUE"?
  - source attributes 'RD','x','XX' are not in NWT manual; assign to "NOT_IN_SET"
  - NOTE: we use a notList which varies by CAS attribute since the same source attribute is used for all 3 NFL attributes

## nat_non_veg {.tabset}

```{r echo=FALSE, message=FALSE, warning=FALSE}  
friList = c('BE','BR','BU','CB','ES','LA','LL','LS','MO','MU','PO','RE','RI','RO','RS','RT','SL','ST')
notList = c('AP','BP','EL','GP','TS','BL','BM','BY','HE','HF','HG') 
casList = c('BE','RK','EX','EX','EX','LA','EX','WS','EX','EX','LA','LA','RI','RK','WS','RK','SL','ST')
x = mutate(x, nat_non_veg=case_when(
    str_trim(typeclas)=="" ~ "EMPTY_STRING",
    is.na(typeclas) | typeclas %in% notList ~ "NULL_VALUE",
    !typeclas %in% friList ~ "NOT_IN_SET",
    TRUE ~ mapvalues(typeclas, friList, casList)
    ))
```

### RAWFRI

```{r echo=FALSE, message=FALSE, warning=FALSE}  
dfSummary(x["typeclas"], graph.col=FALSE, max.distinct.values=99)
```

### CASFRI

```{r echo=FALSE, message=FALSE, warning=FALSE}  
dfSummary(x["nat_non_veg"], graph.col=FALSE, max.distinct.values=99)
```

## non_for_anth {.tabset}

```{r echo=TRUE, message=FALSE, warning=FALSE}
friList = c('AP','BP','EL','GP','TS')
notList = c('BE','BR','BU','CB','ES','LA','LL','LS','MO','MU','PO','RE','RI','RO','RS','RT','SL','ST','BL','BM','BY','HE','HF','HG')
casList = c('FA','SE','OT','IN','OT')
x = mutate(x, non_for_anth=case_when(
    str_trim(typeclas)=="" ~ "EMPTY_STRING",
    is.na(typeclas) | typeclas %in% notList ~ "NULL_VALUE",
    !typeclas %in% friList ~ "NOT_IN_SET",
    TRUE ~ mapvalues(typeclas, friList, casList)
    ))
```

### RAWFRI

```{r echo=FALSE, message=FALSE, warning=FALSE}  
dfSummary(x["typeclas"], graph.col=FALSE, max.distinct.values=99)
```

### CASFRI

```{r echo=FALSE, message=FALSE, warning=FALSE}  
dfSummary(x["non_for_anth"], graph.col=FALSE, max.distinct.values=99)
```

## non_for_veg {.tabset}


```{r echo=TRUE, message=FALSE, warning=FALSE}
friList = c('BL','BM','BY','HE','HF','HG')
notList = c('BE','BR','BU','CB','ES','LA','LL','LS','MO','MU','PO','RE','RI','RO','RS','RT','SL','ST','AP','BP','EL','GP','TS')
casList = c('BR','BR','BR','HE','HF','HG')
x = mutate(x, non_for_veg=case_when(
    str_trim(typeclas)=="" ~ "EMPTY_STRING",
    is.na(typeclas) | typeclas %in% notList ~ "NULL_VALUE",
    !typeclas %in% friList ~ "NOT_IN_SET",
    TRUE ~ mapvalues(typeclas, friList, casList)
    ))
```

### RAWFRI

```{r echo=FALSE, message=FALSE, warning=FALSE}  
dfSummary(x["typeclas"], graph.col=FALSE, max.distinct.values=99)
```

### CASFRI

```{r echo=FALSE, message=FALSE, warning=FALSE}  
dfSummary(x["non_for_veg"], graph.col=FALSE, max.distinct.values=99)
```


# DST Attributes

## dist_type_1 {.tabset}

  - Note that 'UN' is undisturbed, the default value. Assigned to NULL_VALUE?
  - Assigned ('DT','SN','VT') to 'DT'
  - Assigned (PO=ponds,SL=slide) to 'OT'

```{r echo=TRUE, message=FALSE, warning=FALSE}
friList = c('BT','BU','CC','DT','FL','IK','PO','SL','SN','TH','UK','UN','VT','WI')
casList = c('OT','BU','CO','DT','FL','IK','OT','OT','DT','SI','OT','OT','DT','WF')
x = mutate(x, dist_type_1=case_when(
    is.na(dis1code) | dis1code=='UN' ~ "NULL_VALUE",
    str_trim(dis1code)=="" ~ "EMPTY_STRING",
    !dis1code %in% friList ~ "NOT_IN_SET",
    TRUE ~ mapvalues(dis1code, friList, casList)))
```

### RAWFRI
```{r echo=FALSE, message=FALSE, warning=FALSE}  
dfSummary(x["dis1code"], graph.col=FALSE, max.distinct.values=20)
```

### CASFRI
```{r echo=FALSE, message=FALSE, warning=FALSE}  
dfSummary(x["dist_type_1"], graph.col=FALSE, max.distinct.values=20)
```

## dist_year_1 {.tabset}

  * what should a value of "0" be coded as?

```{r echo=TRUE, message=FALSE, warning=FALSE}
x = mutate(x, dist_year_1=case_when(
    is.na(dis1year) ~ as.integer(-8888),
    dis1year==0 ~ as.integer(0), # NOT SURE WHAT THIS SHOULD BE?
    TRUE ~ as.integer(dis1year)))
```

### RAWFRI
```{r echo=FALSE, message=FALSE, warning=FALSE}  
dfSummary(x["dis1year"], graph.col=FALSE, max.distinct.values=101)
```

### CASFRI
```{r echo=FALSE, message=FALSE, warning=FALSE}  
dfSummary(x$dist_year_1, graph.col=FALSE, max.distinct.values=101)
```

## dist_ext_upper_1, dist_ext_lower_1 {.tabset}


```{r echo=TRUE, message=FALSE, warning=FALSE}
friList = c(1,2,3,4,5)
casListUpper = c(25,50,75,95,100)
casListLower = c(1,26,51,76,96)
x = mutate(x, 
    dist_ext_upper_1=case_when(
    is.na(dis1ext) ~ as.integer(-8888),
    dis1ext==0 ~ as.integer(-8885),
    TRUE ~ as.integer(mapvalues(dis1ext, friList, casListUpper))),
    dist_ext_lower_1=case_when(
    is.na(dis1ext) ~ as.integer(-8888),
    dis1ext==0 ~ as.integer(-8885),
    TRUE ~ as.integer(mapvalues(dis1ext, friList, casListLower)))
    )
```

### RAWFRI

```{r echo=FALSE, message=FALSE, warning=FALSE}  
dfSummary(x["dis1ext"], graph.col=FALSE, max.distinct.values=101)
```

### CASFRI (lower)

```{r echo=FALSE, message=FALSE, warning=FALSE}  
dfSummary(x$dist_ext_lower_1, graph.col=FALSE, max.distinct.values=101)
```

### CASFRI (upper)

```{r echo=FALSE, message=FALSE, warning=FALSE}  
dfSummary(x$dist_ext_upper_1, graph.col=FALSE, max.distinct.values=101)
```
